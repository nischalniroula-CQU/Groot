<!DOCTYPE html>
<html data-bs-theme="light" lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Groot - Manage Businesses</title>
    <link rel="icon" type="image/x-icon" href="/img/favicon.png">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Space+Grotesk&amp;display=swap">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body style="--bs-primary: #13456a;--bs-primary-rgb: 19,69,106;--bs-secondary: #FF8889;--bs-secondary-rgb: 255,136,137;">
    
    <header id="adminHeader"></header>
    
    <div class="container" style="margin-top: 2vw;">
        <div class="row">
            <h4>
            	Manage Businesses 
            	<!--  <a href="addBusiness"><button style="float:right; width: 200px;" class="btn btn-success">Add New Business</button></a>-->
            </h4>
        </div>
    </div>
    <div class="container" style="margin-top: 2vw; margin-bottom: 2vw;">
	    <div class="row">
	    	<div id="business-container"></div>
	        <div id="business-error" style="color: red;"></div>
	    </div>
	</div>

    <footer id="footer"></footer>
    <script src="/js/custom_functions.js"></script>
    <script src="/js/script.js"></script>
    <script>
    $(document).ready(function() {
    	$(document).on('click', '.delete-business', function(event) {
            event.preventDefault();
            var businessId = $(this).data('id');
            if (confirm('Do you want to delete this business?')) {
                window.location.href = '/adminDelete?type=business&id=' + businessId;
            }
        });
    	    	
        var settings = {
            url: "http://localhost:8080/api/business/getall",
            method: "POST",
            timeout: 0,
            headers: {
                "Content-Type": "application/json",
                "Cookie": "JSESSIONID=93220C675784A6D747D74967918798FF"
            },
            data: JSON.stringify({
                name: null,
                categoryID: null,
                cultureID: null,
                country: null,
                city: null
            }),
        };

        $.ajax(settings).done(function(response) {
            console.log('Success response:', response); // Log the success response to the console

            if (response.businesses && Array.isArray(response.businesses)) {
                var content = '<table class="table"><thead class="thead-dark"><tr><th>Name</th><th>Location</th><th>Category</th><th>Added By</th><th>Culture</th><th>Action</th></tr></thead><tbody>';
                
                response.businesses.forEach(function(business) {
                    var categoryName = 'Not specified';
                    var cityName = 'Not specified';
                    var ownerName = 'Not specified';
                    var cultureName = 'Not specified';

                    var categoryPromise = fetchCategoryById(business.categoryId)
                        .then(name => categoryName = name)
                        .catch(() => categoryName = 'Not specified');

                    var cityPromise = fetchCityById(business.city)
                        .then(name => cityName = name)
                        .catch(() => cityName = 'Not specified');

                    var ownerPromise = fetchOwnerById(business.ownerId)
                        .then(name => ownerName = name)
                        .catch(() => ownerName = 'Not specified');

                    var culturePromise = fetchCultureById(business.cultureId)
                        .then(name => cultureName = name)
                        .catch(() => cultureName = 'Not specified');

                    Promise.all([categoryPromise, cityPromise, ownerPromise, culturePromise]).then(function() {
                        content += '<tr class="culture-entry">' +
                                   '<td width="25%">' + business.name + '</td>' +
                                   '<td width="20%">' + cityName + '</td>' +
                                   '<td width="10%">' + categoryName + '</td>' +
                                   '<td width="10%">' + ownerName + '</td>' +
                                   '<td width="10%">' + cultureName + '</td>' +
                                   '<td width="15%"><a target="_blank;" href="/business?id=' + business.businessId + '"><button class="btn btn-success">View</button></a>&nbsp;<a href="#" class="delete-business" data-id="' + business.businessId + '"><button class="btn btn-danger">Delete</button></a></td>' +
                                   '</tr>';
                        $('#business-container').html(content);
                    });
                });
            } else {
                $('#business-container').html('<p>No businesses found.</p>');
                console.error('Invalid response format:', response);
            }
        }).fail(function(xhr) {
            console.error('Failed to retrieve business:', xhr.responseText); // Log the error response to the console
            $('#business-error').text('Failed to retrieve business data: ' + JSON.stringify(xhr.responseText));
        });

        function fetchCategoryById(categoryId) {
            return $.ajax({
                url: `/api/categories/getByID/${categoryId}`,
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(function(response) {
                return response.categoryName;
            }).catch(function() {
                return 'Not specified';
            });
        }

        function fetchCityById(cityId) {
            var settings = {
                    url: `/api/cities/id/${cityId}`,
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json"
                    }
                };

                return $.ajax(settings).then(function(response) {
                    return response.cityName;
                }).catch(function() {
                    return 'Not specified';
                });
            }

        function fetchOwnerById(ownerId) {
            return $.ajax({
                url: `/api/user/id/${ownerId}`,
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(function(response) {
                return response.firstName;
            }).catch(function() {
                return 'Not specified';
            });
        }

        function fetchCultureById(cultureId) {
            return $.ajax({
                url: `/api/cultures/getByID/${cultureId}`,
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(function(response) {
                return response.cultureName;
            }).catch(function() {
                return 'Not specified';
            });
        }
    });


    
    $(document).ready(function() {
        // Load the header and footer into div
        $('#adminHeader').load('adminHeader');
        $('#footer').load('footer');
    });
    </script>
</body>

</html>