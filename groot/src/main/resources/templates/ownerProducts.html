<!DOCTYPE html>
<html data-bs-theme="light" lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Groot - Manage Products</title>
    <link rel="icon" type="image/x-icon" href="/img/favicon.png">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Space+Grotesk&amp;display=swap">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body style="--bs-primary: #13456a;--bs-primary-rgb: 19,69,106;--bs-secondary: #FF8889;--bs-secondary-rgb: 255,136,137;">
    
    <header id="ownerHeader"></header>
    
    <div class="container" style="margin-top: 2vw;">
        <div class="row">
            <h4>
            	My Products 
            	<a href="addProduct"><button style="float:right; width: 200px;" class="btn btn-success">Add New Product</button></a>
            </h4>
        </div>
    </div>
    <div class="container" style="margin-top: 2vw; margin-bottom: 2vw;">
	    <div class="row">
	    	<div id="product-container"></div>
	        <div id="product-error" style="color: red;"></div>
	    </div>
	</div>

    <footer id="footer"></footer>
    <script src="/js/custom_functions.js"></script>
    <script src="/js/script.js"></script>
    <script>
    $(document).ready(function() {
        $(document).on('click', '.delete-product', function(event) {
            event.preventDefault();
            var eventId = $(this).data('id');
            if (confirm('Do you want to delete this product?')) {
                window.location.href = '/ownerDelete?type=product&id=' + eventId;
            }
        });
    });
    $(document).ready(function() {
        function fetchOwnerById(ownerId) {
            return $.ajax({
                url: `/api/user/id/${ownerId}`,
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(function(response) {
                return response.firstName;
            }).catch(function() {
                return 'Not specified';
            });
        }

        function fetchBusinessById(businessId) {
            return $.ajax({
                url: `/api/business/getbyid`,
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },
                data: { businessId: businessId }
            }).then(function(response) {
                return response.name;
            }).catch(function() {
                return 'Not specified';
            });
        }

        var userToken = JSON.parse(localStorage.getItem('userToken'));

        if (userToken && userToken.userDetail && userToken.userDetail.uid) {
            var uid = userToken.userDetail.uid;

            $.ajax({
                url: "/api/user/" + uid,
                method: "GET",
                success: function(response) {
                    var userId = response.userId;

                    var settings = {
                        url: "/api/business/getbyfilter",
                        method: "POST",
                        timeout: 0,
                        headers: {
                            "Content-Type": "application/json",
                            "Cookie": "JSESSIONID=93220C675784A6D747D74967918798FF"
                        },
                        data: JSON.stringify({
                            categoryID: null,
                            cultureID: null,
                            ownerId: userId
                        })
                    };

                    $.ajax(settings).done(function(response) {
                        console.log('Success response:', response);

                        if (response.businesses && Array.isArray(response.businesses)) {
                            var businessIds = response.businesses.map(function(business) {
                                return business.businessId;
                            });

                            var fetchBusinessNamesPromises = businessIds.map(function(businessId) {
                                return fetchBusinessById(businessId).then(function(businessName) {
                                    return {
                                        businessId: businessId,
                                        businessName: businessName
                                    };
                                });
                            });

                            Promise.all(fetchBusinessNamesPromises).then(function(businesses) {
                                var businessNamesMap = {};
                                businesses.forEach(function(business) {
                                    businessNamesMap[business.businessId] = business.businessName;
                                });

                                console.log('Business Names Map:', businessNamesMap);

                                var productPromises = businessIds.map(function(businessId) {
                                    var productParams = {
                                        linkedId: businessId,
                                        productTitle: null,
                                        productDescription: null,
                                        price: null,
                                        status: null
                                    };

                                    return $.ajax({
                                        url: '/api/product/getbyfilter',
                                        type: 'POST',
                                        contentType: 'application/json',
                                        headers: {
                                            "Cookie": "JSESSIONID=934B0E0C2B4F0E35CC8454CB2A28AE6B"
                                        },
                                        data: JSON.stringify(productParams)
                                    }).then(function(response) {
                                        return {
                                            businessId: businessId,
                                            products: response.products
                                        };
                                    });
                                });

                                Promise.all(productPromises).then(function(allProductData) {
                                    var content = '<table class="table"><thead class="thead-dark"><tr><th>Product Title</th><th>Business Name</th><th>Description</th><th>Price</th><th>Action</th></tr></thead><tbody>';

                                    allProductData.forEach(function(data) {
                                        var businessName = businessNamesMap[data.businessId];
                                        var products = data.products;

                                        products.forEach(function(product) {
                                            content += '<tr class="culture-entry">' +
                                                '<td width="25%">' + (product.productTitle || '') + '</td>' +
                                                '<td width="20%">' + businessName + '</td>' +
                                                '<td width="10%">' + (product.productDescription || '') + '</td>' +
                                                '<td width="10%">' + (product.price || '') + '</td>' +
                                                '<td width="15%"><a href="#" class="delete-product" data-id="' + product.promoId + '"><button class="btn btn-danger">Delete</button></a></td>' +
                                                '</tr>';
                                        });
                                    });

                                    content += '</tbody></table>';
                                    $('#product-container').html(content);
                                }).catch(function(error) {
                                    console.error('Failed to retrieve products:', error);
                                    $('#product-error').text('Failed to retrieve products.');
                                });
                            }).catch(function(error) {
                                console.error('Failed to fetch business names:', error);
                                $('#product-error').text('Failed to fetch business names.');
                            });
                        } else {
                            $('#business-container').html('<p>No businesses found.</p>');
                            console.error('Invalid response format:', response);
                        }
                    }).fail(function(xhr) {
                        console.error('Failed to retrieve business:', xhr.responseText);
                        $('#business-error').text('Failed to retrieve business data: ' + JSON.stringify(xhr.responseText));
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Failed to get user details:', status, error);
                }
            });
        }
    });
	</script>
    <script>
    $(document).ready(function() {
        // Load the header and footer into div
        $('#ownerHeader').load('ownerHeader');
        $('#footer').load('footer');
    });
    </script>
</body>

</html>
